<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Heart Box Challenge</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Three.js from CDN (still works if internet is up, otherwise fails. But assuming standard connectivity) -->
    <!-- If offline, user needs local three.js. I'll stick to CDN as per original file -->
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
</head>
<body>

    <!-- 3D World -->
    <div id="world"></div>
    
    <!-- Dim Background Overlay -->
    <div id="dim-overlay"></div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <!-- Header Removed -->

        <div class="inventory-panel">
            <div class="inv-title">Keys Collected: <span id="key-counter">0/0</span></div>
            <div class="inv-title">Photos: <span id="photo-counter">0/10</span></div>
        </div>
        
        <!-- Tools Panel -->
        <div class="tools-panel" id="tools-panel">
            <div class="tool-slot" id="tool-cutter" draggable="true" title="Drag to Box to Cut Tape" style="display: none;">
                üî™
            </div>
            <div class="tool-slot" id="tool-hammer" draggable="true" title="Drag to Mirrors to Smash" style="display: none;">
                üî®
            </div>
            <div class="tool-slot" id="tool-box" draggable="true" title="Drag to Bed" style="display: none;">
                üì¶
            </div>
            <div class="tool-slot" id="tool-phone" title="Click to View" style="display: none; cursor: pointer;">
                üì±
            </div>
            <div class="tool-label">Tools</div>
        </div>

        <!-- Light Switch -->
        <label class="light-switch">
          <input type="checkbox" id="light-toggle" checked>
          <span class="slider round"></span>
          <span class="label-text">üí° Light</span>
        </label>

        <div class="nav-label">Use buttons or arrow keys to rotate box</div>
        <div class="nav-controls" id="box-controls">
            <!-- Back Button -->
            <button id="back-scene-btn" class="nav-btn" title="Back to Room" style="border-radius: 2rem; width: auto; padding: 0 1rem; opacity: 0; pointer-events: none; margin-right: 1rem;">
                ‚Üê Back
            </button>
            <button class="nav-btn" id="nav-left" title="Rotate Left">‚Üê</button>
            <button class="nav-btn" id="nav-home" title="Home View">‚åÇ</button>
            <button class="nav-btn" id="nav-flip" title="Flip Upside Down">‚Üª</button>
            <button class="nav-btn" id="nav-right" title="Rotate Right">‚Üí</button>
            <div style="width: 20px;"></div>
            <button class="nav-btn" id="nav-zoom-out" title="Zoom Out">-</button>
            <button class="nav-btn" id="nav-zoom-in" title="Zoom In">+</button>
        </div>

        <div class="nav-controls" id="card-controls" style="display: none;">
            <button class="nav-btn" id="card-prev" title="Close Card">‚Üê</button>
            <div style="width: 44px;"></div> <!-- Spacer -->
            <button class="nav-btn" id="card-next" title="Open Card">‚Üí</button>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" style="display: none;">
            <h3>Admin Menu</h3>
            
            <div class="admin-section">
                <span>Scene:</span>
                <button onclick="window.App.Admin.setScene('intro')">1</button>
                <button onclick="window.App.Admin.setScene('package')">2</button>
                <button onclick="window.App.Admin.setScene('puzzle')">3</button>
                <button onclick="window.App.Admin.setScene('heart')">4</button>
            </div>

            <div class="admin-section">
                <button onclick="window.App.Admin.toggleLight()">Toggle Lights</button>
            </div>

            <div class="admin-section">
                <span>Mirrors:</span>
                <button onclick="window.App.Admin.breakMirrors(true)">Break</button>
                <button onclick="window.App.Admin.breakMirrors(false)">Fix</button>
            </div>

            <div class="admin-section">
                <span>Tools:</span>
                <button onclick="window.App.Admin.toggleTools(true)">Collect</button>
                <button onclick="window.App.Admin.toggleTools(false)">Return</button>
            </div>

            <div class="admin-section">
                <div>Puzzles:</div>
                <button onclick="window.App.Admin.solvePuzzle('all')">All</button>
                <button onclick="window.App.Admin.unsolveAll()">Unsolve All</button>
                <div class="grid-buttons">
                    <button onclick="window.App.Admin.solvePuzzle(0)">1</button>
                    <button onclick="window.App.Admin.solvePuzzle(1)">2</button>
                    <button onclick="window.App.Admin.solvePuzzle(2)">3</button>
                    <button onclick="window.App.Admin.solvePuzzle(3)">4</button>
                    <button onclick="window.App.Admin.solvePuzzle(4)">5</button>
                    <button onclick="window.App.Admin.solvePuzzle(5)">6</button>
                    <button onclick="window.App.Admin.solvePuzzle(6)">7</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Puzzle Modal -->
    <div class="modal-overlay" id="puzzle-modal">
        <div class="modal-card">
            <span class="puzzle-icon">üîê</span>
            <h2 id="puzzle-title">Locked!</h2>
            <p id="puzzle-question">Solve this riddle to get the key.</p>
            <input type="text" class="puzzle-input" id="puzzle-answer" placeholder="Your answer..." autocomplete="off">
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-cancel">Later</button>
                <button class="btn btn-primary" id="modal-submit">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Reward Modal -->
    <div class="modal-overlay" id="reward-modal">
        <div class="reward-card">
            <span class="heart-icon">üíñ</span>
            <h1>Congratulations!</h1>
            <p>
                You have successfully unlocked all the locks and opened the Heart Box!
                <br>
                <strong>"Love is the key that opens the gates of happiness."</strong>
            </p>
            <button class="btn btn-primary" onclick="window.location.reload()">Lock it again</button>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div class="modal-overlay" id="gallery-modal">
        <div class="gallery-container">
            <button class="gallery-close" id="gallery-close-btn">&times;</button>
            <div class="gallery-content">
                <button class="gallery-nav" id="gallery-prev">&#10094;</button>
                <div class="gallery-image-wrapper">
                    <img id="gallery-image" src="" alt="Memory">
                    <div class="gallery-counter" id="gallery-counter">1 / 4</div>
                </div>
                <button class="gallery-nav" id="gallery-next">&#10095;</button>
            </div>
        </div>
    </div>
    
    <!-- Paper Modal -->
    <div class="modal-overlay" id="paper-modal">
        <div class="modal-card paper-style" style="background: #fdfbf7; color: #333; font-family: 'Courier New', monospace; text-align: left; padding: 3rem; transform: rotate(1deg); box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h2 style="text-align: center; text-decoration: underline; margin-bottom: 2rem; color: #333;">WORLD TOUR PLANS</h2>
            <div style="font-size: 1.1rem; line-height: 2rem;">
                <p><strong>STEP 1:</strong> PLAN THE WORLD TOUR</p>
                <p><strong>STEP 2:</strong> PICK A FLOWER AT EACH DESTINATION</p>
                <p><strong>STEP 3:</strong> SUCCESS UNLOCKED!</p>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="document.getElementById('paper-modal').classList.remove('active')">Close</button>
            </div>
        </div>
    </div>

    <!-- Card Modal -->
    <div class="modal-overlay" id="card-modal">
        <div class="modal-card" style="background: #fff0f5; color: #880e4f; text-align: center; padding: 2.5rem; border: 3px solid #f8bbd0; border-radius: 15px; box-shadow: 0 10px 25px rgba(233, 30, 99, 0.2); max-width: 500px;">
            <h2 style="font-family: 'Brush Script MT', cursive; font-size: 3rem; margin-bottom: 1.5rem; color: #d81b60;">To My Love</h2>
            <div style="font-family: 'Georgia', serif; font-size: 1.2rem; line-height: 1.8; color: #4a1428;">
                <p>Happy Valentine's Day!</p>
                <p>You have unlocked my heart.</p>
                <p>Every moment with you is a treasure.</p>
                <p>Here's to many more adventures together.</p>
                <p style="font-size: 2rem; margin-top: 1rem;">‚ù§Ô∏è</p>
            </div>
            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" style="background: #e91e63; border-color: #c2185b;" onclick="document.getElementById('card-modal').classList.remove('active')">Close Card</button>
            </div>
        </div>
    </div>

    <!-- Phone Modal -->
    <div class="modal-overlay" id="phone-modal">
        <div class="phone-screen-container">
             <div class="phone-body">
                 <div class="phone-notch"></div>
                 <div class="phone-display">
                     <div class="phone-status-bar">
                        <span id="phone-clock-small">12:00</span>
                        <span>üì∂ üîã</span>
                     </div>
                     
                     <!-- Notification Banner -->
                     <div id="phone-notification-banner" class="notification-banner">
                         <div class="notif-icon">üí¨</div>
                         <div class="notif-content">
                             <div class="notif-title">Messages</div>
                             <div class="notif-text" id="notif-text-content">New Message</div>
                         </div>
                     </div>

                     <!-- Home Screen -->
                     <div id="phone-home-screen" class="phone-screen active">
                         <div class="phone-clock-large" id="phone-clock-large">12:00</div>
                         <div class="app-grid">
                             <div class="app-item" onclick="window.App.Phone.openApp('phone')">
                                 <div class="app-icon" style="background:#4cd964">üìû</div>
                                 <span>Phone</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('messages')">
                                 <div class="app-icon" style="background:#34c759; position: relative;">
                                     üí¨
                                     <span id="msg-badge" style="position: absolute; top: -5px; right: -5px; font-size: 1rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); display: none;">üî¥</span>
                                 </div>
                                 <span>Messages</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('internet')">
                                 <div class="app-icon" style="background:#007aff">üåê</div>
                                 <span>Internet</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('photos')">
                                 <div class="app-icon" style="background:conic-gradient(#ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff, #5856d6, #ff2d55)">üñºÔ∏è</div>
                                 <span>Photos</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('smarthome')">
                                 <div class="app-icon" style="background:#ff9500">üè†</div>
                                 <span>Home</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('heartbox')">
                                 <div class="app-icon" style="background:#ff2d55">üíñ</div>
                                 <span>HeartBox</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('news')">
                                 <div class="app-icon" style="background:#ff3b30">üì∞</div>
                                 <span>News</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('maps')">
                                 <div class="app-icon" style="background:#5ac8fa">üó∫Ô∏è</div>
                                 <span>Maps</span>
                             </div>
                             <div class="app-item" onclick="window.App.Phone.openApp('notes')">
                                 <div class="app-icon" style="background:#ffcc00">üìù</div>
                                 <span>Notes</span>
                             </div>
                         </div>
                     </div>

                     <!-- Apps -->
                     <div id="app-phone" class="phone-app">
                         <div class="app-header">Phone <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content-scroll">
                             <div class="call-log-item">
                                 <div class="caller-icon">V</div>
                                 <div class="caller-info">
                                     <div class="caller-name">Vinny</div>
                                     <div class="call-type">Incoming Call</div>
                                 </div>
                                 <div class="call-time">10:30 AM</div>
                             </div>
                             <div class="call-log-item">
                                 <div class="caller-icon self">M</div>
                                 <div class="caller-info">
                                     <div class="caller-name">Me</div>
                                     <div class="call-type">Outgoing Call</div>
                                 </div>
                                 <div class="call-time">Yesterday</div>
                             </div>
                             <!-- Repeat -->
                             <div class="call-log-item"><div class="caller-icon">V</div><div class="caller-info"><div class="caller-name">Vinny</div><div class="call-type">Missed Call</div></div><div class="call-time">Yesterday</div></div>
                         </div>
                     </div>

                     <div id="app-messages" class="phone-app">
                         <div class="app-header">Vinny <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content-scroll messages-container">
                             <div class="msg-bubble received">Hey! Happy Valentine's Day! ‚ù§Ô∏è</div>
                             <div class="msg-bubble sent">Happy Valentine's! I love you!</div>
                             <div class="msg-bubble received">I have a surprise for you... check under the bed üòâ</div>
                             <div class="msg-bubble sent">Ooo exciting! On my way to look!</div>
                         </div>
                     </div>

                     <div id="app-internet" class="phone-app">
                         <div class="app-header">Safari <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content center-content">
                             <h2>Google</h2>
                             <div class="search-bar-fake">Happy Valentine's Day Ideas...</div>
                         </div>
                     </div>

                     <div id="app-photos" class="phone-app">
                         <div class="app-header">Photos <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content-scroll">
                             <div class="photos-grid-container" id="phone-photos-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px;">
                                 <!-- Populated via JS -->
                             </div>
                         </div>
                     </div>

                     <div id="app-smarthome" class="phone-app">
                         <div class="app-header">Home <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content-scroll">
                             <div class="home-device-card">
                                 <h3>Bookshelf Light</h3>
                                 <label>Brightness</label>
                                 <input type="range" min="0" max="2" step="0.1" value="1.2" oninput="window.App.Phone.updateLight('book', 'brightness', this.value)">
                                 <label>Color</label>
                                 <input type="color" value="#FFFFE0" onchange="window.App.Phone.updateLight('book', 'color', this.value)">
                             </div>
                             <div class="home-device-card">
                                 <h3>Geometric Lamp</h3>
                                 <label>Brightness</label>
                                 <input type="range" min="0" max="2" step="0.1" value="1.0" oninput="window.App.Phone.updateLight('geo', 'brightness', this.value)">
                                 <label>Color</label>
                                 <input type="color" value="#FFFFFF" onchange="window.App.Phone.updateLight('geo', 'color', this.value)">
                             </div>
                         </div>
                     </div>

                     <div id="app-heartbox" class="phone-app">
                         <div class="app-header">HeartBox <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content center-content">
                             <button class="btn btn-primary" onclick="window.open(window.location.href, '_blank')">Open Website</button>
                         </div>
                     </div>

                     <div id="app-news" class="phone-app">
                         <div class="app-header">News <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content-scroll">
                             <div class="news-article">
                                 <h4>BREAKING: Couple Goals Achieved</h4>
                                 <p>Sources confirm Vinny and Vidhi are having an amazing celebration.</p>
                             </div>
                             <div class="news-article">
                                 <h4>Valentine's Day Special</h4>
                                 <p>Chocolate sales skyrocket as love fills the air.</p>
                             </div>
                             <div class="news-article">
                                 <h4>Weather Report</h4>
                                 <p>100% chance of romance tonight.</p>
                             </div>
                         </div>
                     </div>

                     <div id="app-maps" class="phone-app">
                         <div class="app-header">Maps <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content" style="background:#e5e5e5; display: flex; align-items: center; justify-content: center; color: #555;">
                             (Map View Placeholder)
                             üìç You are here (In Love)
                         </div>
                     </div>

                     <div id="app-notes" class="phone-app">
                         <div class="app-header">Notes <span class="app-close" onclick="window.App.Phone.closeApp()">&times;</span></div>
                         <div class="app-content-scroll">
                             <div class="note-item" onclick="alert('Grocery List: \n- Milk\n- Eggs\n- Chocolate')">Grocery List</div>
                             <div class="note-item" onclick="alert('Ideas:\n- Buy flowers\n- Plan dinner')">Gift Ideas</div>
                             <div class="note-item" onclick="alert('Remember to water the plants!')">To Do</div>
                         </div>
                     </div>

                 </div>
                 <button class="phone-home-btn" id="phone-home-btn"></button>
             </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span>üîë</span> <span id="toast-msg">You found a key!</span>
    </div>

    <!-- App Scripts (LOAD ORDER MATTERS) -->
    <script src="js/state.js"></script>
    
    <!-- Puzzles -->
    <script src="js/puzzles/Puzzle1.js"></script>
    <script src="js/puzzles/Puzzle2.js"></script>
    <script src="js/puzzles/Puzzle3.js"></script>
    <script src="js/puzzles/Puzzle4.js"></script>
    <script src="js/puzzles/Puzzle5.js"></script>
    <script src="js/puzzles/Puzzle6.js"></script>
    <script src="js/puzzles/PuzzleRegistry.js"></script>

    <script src="js/utils/Tween.js"></script>
    <script src="js/ui/PuzzleModal.js"></script>
    <script src="js/ui/UIManager.js"></script>
    
    <!-- Utilities -->
    <script src="js/utils/TextureFactory.js"></script>
    
    <!-- Room Objects -->
    <script src="js/roomObjects/Bookshelf.js"></script>
    <script src="js/roomObjects/Bed.js"></script>
    <script src="js/roomObjects/SideTable.js"></script>
    <script src="js/roomObjects/MirrorGrid.js"></script>
    <script src="js/roomObjects/FlowerGrid.js"></script>
    <script src="js/roomObjects/LongPillow.js"></script>
    <script src="js/roomObjects/SquarePillow.js"></script>
    <script src="js/roomObjects/HolePillow.js"></script>
    <script src="js/roomObjects/FlowerBlanket.js"></script>
    <script src="js/roomObjects/StripeBlanket.js"></script>
    <script src="js/roomObjects/FlowerPainting.js"></script>
    <script src="js/roomObjects/Carpet.js"></script>
    <script src="js/roomObjects/GeometricLamp.js"></script>
    <script src="js/roomObjects/SilverBonsai.js"></script>
    
    <!-- Scenes -->
    <script src="js/scenes/IntroScene.js"></script>
    <script src="js/scenes/PackageScene.js"></script>
    <script src="js/scenes/PuzzleScene.js"></script>
    <script src="js/scenes/HeartScene.js"></script>

    <!-- Phone System -->
    <script src="js/phone/Phone.js"></script>
    <script src="js/phone/apps/PhotosApp.js"></script>
    <script src="js/phone/apps/SmartHomeApp.js"></script>
    <script src="js/phone/apps/MapsApp.js"></script>

    <!-- Components -->
    <script src="js/locks/HeartLock.js"></script>
    <script src="js/locks/ScrewLock.js"></script>
    <script src="js/locks/TapeLock.js"></script>
    <script src="js/locks/DigitLock.js"></script>
    <script src="js/locks/LockFactory.js"></script>
    <script src="js/components/CardContent.js"></script>
    <script src="js/components/PhotoGallery.js"></script>
    <script src="js/components/HeartBox.js"></script>
    <script src="js/components/CardboardBox.js"></script>
    <script src="js/main.js"></script>
</body>
</html>